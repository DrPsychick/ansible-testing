---
os: linux
dist: focal
language: python
cache: pip
services:
  - docker

install:
  - pip3 install -U ansible jq docker
  - printf "[defaults]\nroles_path = ../" > ansible.cfg

script:
  - ansible-playbook tests/create.yml --syntax-check
  - ls -la /sys/fs/cgroup
  - (cd files/docker; docker build -t test -f Dockerfile_Ubuntu .)
  - docker run --rm -d --privileged -v /sys/fs/cgroup:/sys/fs/cgroup:ro --name ubuntu test /sbin/init
  - sleep 5; docker exec -it ubuntu systemctl
  - docker rm ubuntu
  - yes | ansible-playbook tests/create.yml --connection=local
  - >
    result=$(yes | ansible-playbook tests/create.yml --connection=local);
    echo "$result" | grep -q 'changed=0.*failed=0'
    && (echo -e "Idempotence test: ${GREEN}pass${NC}"; exit 0)
    || (echo -e "Idempotence test: ${RED}fail${NC}"; echo -e "$result"; exit 1);
  - yes | ansible-playbook tests/destroy.yml --connection=local

notifications:
  webhooks: https://galaxy.ansible.com/api/v1/notifications/
